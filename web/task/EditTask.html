<div class="content">

    <div class="breadcrumb">
        <span class="layui-breadcrumb">
          <a href="javascript:;">首页</a>
            <span lay-separator="">/</span>
          <a href="javascript:;">任务管理</a>
            <span lay-separator="">/</span>
          <a><cite>添加任务</cite></a>
        </span>
    </div>

    <div class="douruimi-form edit-goods" style=" overflow-y: auto;height:700px;">
        <form class="layui-form" action="" onsubmit="return false">

            <input type="text" class="layui-input" style="display: none" name="id" id="id">

            <div class="layui-form-item">
                <label class="layui-form-label"><span class="input-must">*</span>项目名称</label>
                <div class="layui-input-inline">
                    <input type="text" maxlength="100" lay-verify="required" autocomplete="off" placeholder=""
                           class="layui-input" name="projectName" id="projectName">
                </div>
                <div class="layui-form-mid layui-word-aux"></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span class="input-must">*</span>项目简介</label>
                <div class="layui-input-inline">
                    <input type="text" maxlength="100" lay-verify="required" autocomplete="off" placeholder=""
                           class="layui-input" name="projectIntroduce" id="projectIntroduce">
                </div>
                <div class="layui-form-mid layui-word-aux"></div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label"><span class="input-must">*</span>项目标签</label>
                <div class="layui-input-inline">
                    <input type="text" maxlength="50" lay-verify="required" autocomplete="off" placeholder=""
                           class="layui-input" name="projectLabel" id="projectLabel">
                </div>
                <div class="layui-form-mid layui-word-aux"></div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label"><span class="input-must">*</span>推荐指数</label>
                <div class="layui-input-inline">
                    <div id="test2"></div>
                </div>
                <div class="layui-form-mid layui-word-aux"></div>
            </div>


            <div class="layui-form-item">
                <label class="layui-form-label">项目步骤</label>
                <div class="layui-input-inline" style="width:800px">
                    <textarea name="ueditorContent" id="ueditorContent"></textarea>
                </div>
                <div class="layui-form-mid layui-word-aux"></div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-filter="save" lay-submit="">保存</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>


<script>


    layui.use(['tinymce', 'util', 'layer', 'form', 'rate', 'setting'], function () {

        var t = layui.tinymce
             ,rate = layui.rate
            , form = layui.form
            ,setting = layui.setting
            , $ = layui.$;


        var APIUrl = setting.api_url;
        var RichID = "#ueditorContent";

        // 五星好评
        rate.render({
            elem: '#test2'
            , value: 5 //初始值
            , text: false //开启文本
        });

        // 富文本
        t.render({
            elem: RichID
            , height: 400
            , images_upload_url: ""   //上传地址
            , automatic_uploads: false   //加上了就不上传

            // 其余配置可参考官方文档
        }, function (opt) {
            //加载完成后回调
        });


        $(document).ready(function () {

            // 获取前面传过来的参数
            var taskID = localStorage.getItem("id");
            localStorage.removeItem('id');

            // console.log("taskID:"+taskID);

            if (typeof(taskID) != "undefined") {

                var load_index = layer.load(1);
                $.ajax({
                    type: "GET",
                    url: APIUrl + "/api/index/task/getOneByID",
                    data: {id: taskID},
                    dataType: "json",
                    success: function (data) {
                        // console.log(data);
                        if (data.data != null) {
                            setTimeout(function () {
                                $("#id").val(data.data.id);
                                $("#projectName").val(data.data.projectName);
                                $("#projectIntroduce").val(data.data.projectIntroduce);
                                $("#projectLabel").val(data.data.projectLabel);
                                t.get(RichID).insertContent(data.data.ueditorContent);
                                $("#projectState").val(data.data.projectState);
                            }, 1000);
                        }
                    }
                    , error() {
                        console.log("获取用户信息err");
                        layer.msg('请检查网络设置，再重试');
                    }
                    , complete: function () {
                        layer.close(load_index);
                    }
                });

            }

        });
        // console.log(getAPIUrl());


        form.on('submit(save)', function (data) {

            var ueditorContent = t.get(RichID).getContent();

            // layer.alert(ueditorContent);
            // return false;

            var formJson = data.field;
            var recommendedIndex = $(".layui-icon-rate-solid").length;
            // console.log(ueditorContent.length);
            // console.log(recommendedIndex);

            if (ueditorContent.length == 0) {
                layer.msg("请输入项目步骤");
                return false;
            }

            formJson.ueditorContent = ueditorContent;
            formJson.recommendedIndex = recommendedIndex;

            // console.log(JSON.stringify(formJson));

            // console.log(APIUrl + "api/index/task/save?jsonStr="+JSON.stringify(formJson));


            var load_index = layer.load(1);
            $.ajax({
                type: "POST",
                url: APIUrl + "/api/index/task/save",
                data: {
                    "jsonStr": JSON.stringify(formJson)
                },
                dataType: "json",
                success: function (data) {
                    // console.log(data);
                    if (data.code == "000") {

                        // console.log(data);
                        layer.msg('保存成功');
                        setTimeout(function () {
                            window.location.href = "#/task/ListTask";
                        }, 2000);
                    } else {
                        layer.msg(data.msg);
                        setTimeout(function () {
                            // window.location.href = "/taskPlatform-web/web/login.html";
                        }, 2000);
                    }
                }
                , error() {
                    console.log("task保存err");
                    layer.msg('请检查网络设置，再重试');
                }
                , complete: function () {
                    layer.close(load_index);

                }
            });


        });


    });
</script>